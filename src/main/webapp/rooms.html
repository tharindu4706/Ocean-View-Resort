<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rooms - Ocean View Resort</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Room Management</h1>
            <p>Manage Hotel Rooms</p>
        </header>

        <nav>
            <a href="dashboard.html">Dashboard</a>
            <a href="guests.html">Guests</a>
            <a href="room-categories.html">Room Categories</a>
            <a href="rooms.html">Rooms</a>
            <a href="reservations.html">Reservations</a>
            <a href="help.html">Help</a>
        </nav>

        <main>
            <section>
                <h2>All Rooms</h2>
                <button onclick="showAddForm()" class="btn">+ Add New Room</button>

                <div id="addForm" style="display:none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 id="formTitle">Add New Room</h3>
                    <form id="roomForm">
                        <input type="hidden" id="roomId">
                        <div class="form-group">
                            <label>Room Number:</label>
                            <input type="text" id="roomNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Room Type (Category):</label>
                            <select id="categoryId" required>
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status:</label>
                            <select id="available" required>
                                <option value="true">Available</option>
                                <option value="false">Occupied</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Save Room</button>
                        <button type="button" onclick="hideAddForm()" class="btn" style="background: #7f8c8d;">Cancel</button>
                    </form>
                </div>

                <table id="roomsTable">
                    <thead>
                        <tr>
                            <th>Room Number</th>
                            <th>Room Type</th>
                            <th>Day Use</th>
                            <th>Overnight</th>
                            <th>Capacity</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="roomsList">
                        <tr>
                            <td colspan="7">Loading rooms...</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>

        <footer>
            <p>&copy; 2026 Ocean View Resort. All rights reserved.</p>
        </footer>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/oceanview-resort/api';

        async function showAddForm() {
            document.getElementById('formTitle').textContent = 'Add New Room';
            document.getElementById('roomForm').reset();
            document.getElementById('roomId').value = '';
            await loadCategoriesDropdown();
            document.getElementById('addForm').style.display = 'block';
        }

        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('roomForm').reset();
        }

        async function loadCategoriesDropdown() {
            try {
                const response = await fetch(`${API_BASE}/room-categories/`);
                const result = await response.json();

                if (result.success && result.data) {
                    const select = document.getElementById('categoryId');
                    select.innerHTML = '<option value="">Select Category</option>';
                    result.data.forEach(cat => {
                        select.innerHTML += `<option value="${cat.categoryId}">${cat.categoryName} - ${cat.capacity} person(s)</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms/`);
                const result = await response.json();

                if (result.success && result.data) {
                    displayRooms(result.data);
                } else {
                    document.getElementById('roomsList').innerHTML = '<tr><td colspan="7">No rooms found</td></tr>';
                }
            } catch (error) {
                document.getElementById('roomsList').innerHTML = '<tr><td colspan="7">Error loading rooms</td></tr>';
            }
        }

        function displayRooms(rooms) {
            const tbody = document.getElementById('roomsList');
            if (rooms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No rooms available.</td></tr>';
                return;
            }

            tbody.innerHTML = rooms.map(room => `
                <tr style="background: ${room.available ? '#d4edda' : '#f8d7da'};">
                    <td><strong>${room.roomNumber}</strong></td>
                    <td>${room.categoryName}</td>
                    <td>LKR ${room.dayUsePrice ? room.dayUsePrice.toFixed(2) : '0.00'}</td>
                    <td>LKR ${room.overnightPrice ? room.overnightPrice.toFixed(2) : '0.00'}</td>
                    <td>${room.capacity} person(s)</td>
                    <td><strong>${room.available ? '✅ Available' : '❌ Occupied'}</strong></td>
                    <td>
                        <button onclick="editRoom(${room.roomId})" class="btn" style="padding: 5px 10px; font-size: 12px;">Edit</button>
                        <button onclick="deleteRoom(${room.roomId})" class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('roomForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const roomId = document.getElementById('roomId').value;
            const room = {
                roomNumber: document.getElementById('roomNumber').value,
                categoryId: parseInt(document.getElementById('categoryId').value),
                available: document.getElementById('available').value === 'true'
            };

            try {
                let url = `${API_BASE}/rooms/`;
                let method = 'POST';

                if (roomId) {
                    room.roomId = parseInt(roomId);
                    url = `${API_BASE}/rooms/${roomId}`;
                    method = 'PUT';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(room)
                });

                const result = await response.json();

                if (result.success) {
                    alert(roomId ? 'Room updated successfully!' : 'Room added successfully!');
                    hideAddForm();
                    loadRooms();
                } else {
                    alert('Failed to save room: ' + result.message);
                }
            } catch (error) {
                alert('Error saving room');
            }
        });

        async function deleteRoom(id) {
            if (!confirm('Are you sure you want to delete this room?')) return;

            try {
                const response = await fetch(`${API_BASE}/rooms/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Room deleted!');
                    loadRooms();
                } else {
                    alert('Failed to delete room');
                }
            } catch (error) {
                alert('Error deleting room');
            }
        }

        async function editRoom(id) {
            try {
                const response = await fetch(`${API_BASE}/rooms/${id}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const room = result.data;
                    document.getElementById('formTitle').textContent = 'Edit Room';
                    document.getElementById('roomId').value = room.roomId;
                    document.getElementById('roomNumber').value = room.roomNumber;
                    await loadCategoriesDropdown();
                    document.getElementById('categoryId').value = room.categoryId;
                    document.getElementById('available').value = room.available.toString();
                    document.getElementById('addForm').style.display = 'block';
                } else {
                    alert('Failed to load room data');
                }
            } catch (error) {
                alert('Error loading room data');
            }
        }

        loadRooms();
    </script>
</body>
</html>
